#!/bin/bash
# Проверка правильности ввода. Если введено НЕ 2 аргумента, как требуется, то выведет ошибку.
if [ "$#" -ne 2 ]; then
    echo "Ошибка: Укажите два аргумента."
    echo "Использование: $0 <каталог для бэкапа> <каталог назначения>"
    exit 1
fi

# Инициализация переменных
SOURCE_DIR=$1           # Каталог для бэкапа
DEST_DIR=$2             # Каталог, куда сохраняется бэкап
TIMESTAMP_FILE="$DEST_DIR/last_backup_time"  # Файл с временем последнего бэкапа


# Проверка существования каталогов
if [ ! -d "$SOURCE_DIR" ]; then
    echo "Ошибка: Каталог $SOURCE_DIR не существует или недоступен."
    exit 1
fi

if [ ! -d "$DEST_DIR" ]; then
    echo "Каталог назначения $DEST_DIR не существует. Создаю его..."
    mkdir -p "$DEST_DIR"
    if [ $? -ne 0 ]; then
        echo "Ошибка: Не удалось создать каталог назначения $DEST_DIR."
        exit 1
    fi
fi

# Проверка прав доступа
if [ ! -r "$SOURCE_DIR" ]; then
    echo "Ошибка: Нет прав на чтение из $SOURCE_DIR."
    exit 1
fi

if [ ! -w "$DEST_DIR" ]; then
    echo "Ошибка: Нет прав на запись в $DEST_DIR."
    exit 1
fi

# Проверка файла временной метки
# Если файл с временной меткой существует, читаем из него время последнего бэкапа.
# Если файл поврежден (не содержит числа), выполняется полный бэкап.
# Если файла нет, также выполняется полный бэкап.
if [ -f "$TIMESTAMP_FILE" ]; then
    # Чтение времени последнего бэкапа
    LAST_BACKUP_TIME=$(cat "$TIMESTAMP_FILE")
    if ! [[ "$LAST_BACKUP_TIME" =~ ^[0-9]+$ ]]; then
        echo "Ошибка: Файл временной метки поврежден. Выполняется полный бэкап."
        LAST_BACKUP_TIME=0
    fi
else
    echo "Файл временной метки отсутствует. Выполняется полный бэкап."
    LAST_BACKUP_TIME=0
fi

# Инкрементальный бэкап/
# Используем rsync для копирования измененных файлов.
# Команда find ищет файлы, измененные после времени последнего бэкапа.
# Параметр --progress позволяет отслеживать процесс копирования в реальном времени.
# В случае ошибки rsync скрипт завершает работу.
echo "Начинается бэкап..."
rsync -av --update --progress \
    --files-from=<(find "$SOURCE_DIR" -type f -newermt "@$LAST_BACKUP_TIME" 2>/dev/null) \
    "$SOURCE_DIR/" "$DEST_DIR/"

# Проверка успешности выполнения rsync
if [ $? -ne 0 ]; then
    echo "Ошибка: Бэкап завершился с ошибкой."
    exit 1
fi

# Обновление времени последнего бэкапа
echo $(date +%s) > "$TIMESTAMP_FILE"
if [ $? -ne 0 ]; then
    echo "Ошибка: Не удалось обновить файл временной метки."
    exit 1
fi

echo "Бэкап завершен успешно. Время последнего бэкапа сохранено."
